name: Deployment

on: [push, release]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - name: Check directory
      run: ls -la
    - name: Publish to deploy
      run:  dotnet publish SchVictorina.WebAPI/SchVictorina.WebAPI.csproj -p:PublishDir=publish -c Release
    - name: Remove autogenerated web.config
      run:  rm /home/runner/work/schvictorina/schvictorina/SchVictorina.WebAPI/publish/web.config
    - name: Set correct web.config
      run:  copy /home/runner/work/schvictorina/schvictorina/SchVictorina.WebAPI/publish/web_deploy.config /home/runner/work/schvictorina/schvictorina/SchVictorina.WebAPI/publish/web.config
    - name: Remove settings.xml
      run: rm /home/runner/work/schvictorina/schvictorina/SchVictorina.WebAPI/publish/Config/settings.xml
    - name: Remove users.xml
      run: rm /home/runner/work/schvictorina/schvictorina/SchVictorina.WebAPI/publish/Config/users.xml
    - name: Stop application pool
      uses: sebastianpopp/ftp-action@v2.0.0
      with:
        host: ${{ secrets.FTP_SERVER }}
        user: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        localDir: "/home/runner/work/schvictorina/schvictorina/mock"
        remoteDir: "bot"
    - name: Upload program files and start application pool
      uses: sebastianpopp/ftp-action@v2.0.0
      with:
        host: ${{ secrets.FTP_SERVER }}
        user: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        localDir: "/home/runner/work/schvictorina/schvictorina/SchVictorina.WebAPI/publish"
        remoteDir: "bot"

